# 更新日志

本项目的所有重要变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)，
项目遵循 [语义化版本](https://semver.org/spec/v2.0.0.html) 规范。

## [2.1.0] - 2025-07-05

### 🌟 重大功能新增

#### 📊 增强报告系统
- **多格式报告生成**: 支持TXT、JSON、CSV、HTML、摘要和图表等6种格式
- **HTML交互式报告**: 现代化网页界面，包含Chart.js图表和响应式设计
- **智能摘要报告**: 自动策略评级系统（优秀/良好/一般/较差）
- **可视化图表**: matplotlib生成的高质量收益曲线图
- **报告管理系统**: 完整的文件管理、清理和索引功能
- **策略分类存储**: 按策略名称自动组织报告到独立目录

#### 🌐 真实数据源集成
- **AkShare集成**: 支持A股实时行情数据，包含价格、成交量等交易信息
- **Tushare集成**: 专业金融数据接口支持（需要配置token）
- **智能数据源管理**: 主数据源失败时自动切换到备用数据源
- **配置管理**: 通过 `ptrade_config.yaml` 统一管理数据源配置

#### ⚡ 命令行工具
- **专业CLI**: 全新的 `ptradeSim.py` 命令行工具
- **丰富参数支持**: 全面的参数配置，包括策略文件、数据源、股票代码、时间范围和初始资金
- **多种输出模式**: 详细、安静和普通输出模式，适应不同使用场景
- **智能验证**: 自动参数验证和用户友好的错误提示

### 🛠️ 引擎优化

#### 🔧 核心引擎改进
- **API注入修复**: 解决了类对象错误注入的问题，确保只注入函数对象
- **手续费函数更新**: 新的函数签名 `set_commission(commission_ratio=0.0003, min_commission=5.0, type="STOCK")`
- **性能分析增强**: 改进性能指标计算，对数据不足情况有更好的错误处理
- **兼容性提升**: 移除非标准API（如`on_strategy_end`），确保与ptrade完全兼容

#### 📊 策略改进
- **真实数据策略**: 新增 `real_data_strategy.py` 演示A股真实数据使用
- **智能回退机制**: 历史数据不足时自动切换到简单交易策略
- **详细交易日志**: 中文日志输出，便于策略调试和分析
- **持仓管理**: 修复持仓数据格式问题，支持字典格式的持仓信息

### 🔧 依赖管理
- **模块化依赖**: 将数据源依赖移至可选组，支持按需安装
- **版本冲突解决**: 修复akshare重复定义问题
- **简化安装**: 支持 `poetry install --with data` 安装数据源依赖

### 📚 文档更新
- **全面README**: 更新v2.1.0功能、真实数据源使用和命令行工具文档
- **使用示例**: 添加CSV和真实数据源的完整代码示例
- **参数参考**: 详细的参数表格和使用场景
- **快速开始指南**: 为新用户简化入门流程

### 🧪 测试改进
- **真实数据测试**: 使用实际A股数据进行全面测试（平安银行、万科A、浦发银行）
- **CLI工具测试**: 全面的命令行界面测试，包含各种参数组合
- **错误处理**: 改进错误信息和边缘情况处理
- **报告系统测试**: 多格式报告生成和管理功能的完整测试

### 🔄 破坏性变更
- **命令行工具**: 从 `run_strategy.py` 重命名为 `ptradeSim.py`，提升品牌识别度
- **数据源配置**: 从 `data_path=AkshareDataSource()` 改为 `data_source=AkshareDataSource()`
- **依赖结构**: 数据源现在需要使用 `--with data` 标志显式安装
- **非标准API移除**: 移除 `on_strategy_end` 等非标准API，确保ptrade兼容性

### 🐛 问题修复
- 修复真实数据源的持仓数据访问问题
- 解决历史数据格式不一致问题
- 纠正API注入机制，防止类对象注入
- 修复手续费函数签名兼容性
- 清理所有非标准API引用

### 📈 性能改进
- 优化真实数据源的数据加载
- 改进大数据集的内存使用
- 增强错误处理和恢复机制
- 提升报告生成效率

---

## [2.0.0] - 2024-12

### 新增功能
- 多数据源支持（Tushare、AkShare、CSV）
- 通过YAML文件进行配置管理
- 数据源智能回退机制
- API调用缓存优化
- 与现有CSV数据源的向后兼容性

### 变更内容
- 增强数据源架构
- 改进错误处理和日志记录
- 更新文档结构

### 问题修复
- 数据加载性能问题
- API速率限制问题
- 配置文件解析错误

---

## [1.0.0] - 2024-11

### 新增功能
- ptradeSim首次发布
- 基础回测引擎
- CSV数据源支持
- 策略框架兼容性
- 性能分析工具
- 基础文档

### Features
- Strategy backtesting with historical data
- Portfolio management and tracking
- Performance metrics calculation
- Order execution simulation
- Risk management tools
